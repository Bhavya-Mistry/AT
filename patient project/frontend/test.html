<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Portal API Tester</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; color: #333; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { margin-top: 15px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        pre { background: #2d2d2d; color: #83f52c; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 14px; }
        .response-area { margin-top: 15px; display: none; }
        .error { color: #ff4d4d; }
    </style>
</head>
<body>

    <h1>üè• Patient Portal Backend Tester</h1>

    <div class="card">
        <h2>1. Register New User</h2>
        <form id="userForm">
            <label>Email:</label>
            <input type="email" id="email" placeholder="patient@example.com" required>
            
            <label>Password:</label>
            <input type="password" id="password" placeholder="secret123" required>
            
            <label>Role:</label>
            <select id="role">
                <option value="patient">Patient</option>
                <option value="doctor">Doctor</option>
                <option value="admin">Admin</option>
            </select>

            <button type="submit">Create User</button>
        </form>
        <div id="userResponse" class="response-area">
            <h4>Response:</h4>
            <pre id="userOutput"></pre>
        </div>
    </div>

    <div class="card">
        <h2>2. List All Users</h2>
        <p>Click below to see registered users and get their IDs.</p>
        <button onclick="fetchUsers()">Fetch Users List</button>
        <div id="listResponse" class="response-area">
            <h4>Database Users:</h4>
            <pre id="listOutput"></pre>
        </div>
    </div>

    <div class="card">
        <h2>3. Create Profile for User</h2>
        <form id="profileForm">
            <label>User ID (Check list above):</label>
            <input type="number" id="profileUserId" placeholder="e.g., 1" required>

            <label>Full Name:</label>
            <input type="text" id="fullName" placeholder="John Doe" required>

            <label>Contact No:</label>
            <input type="text" id="contact" placeholder="+1 123-456-7890" required>

            <label>Address:</label>
            <input type="text" id="address" placeholder="123 Health St, NY" required>

            <label>Blood Group:</label>
            <input type="text" id="blood" placeholder="O+" required>

            <label>Current Status:</label>
            <select id="status">
                <option value="mild">Mild</option>
                <option value="critical">Critical</option>
                <option value="past_record">Past Record</option>
            </select>

            <button type="submit">Save Profile</button>
        </form>
        <div id="profileResponse" class="response-area">
            <h4>Response:</h4>
            <pre id="profileOutput"></pre>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000";

        // Helper to display JSON nicely
        function showResponse(elementId, containerId, data) {
            document.getElementById(containerId).style.display = 'block';
            document.getElementById(elementId).textContent = JSON.stringify(data, null, 2);
        }

        // 1. Create User
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;

            try {
                const res = await fetch(`${API_URL}/users/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email, 
                        password, 
                        role,
                        is_2fa_enabled: false, 
                        has_signed_baa: false 
                    })
                });
                const data = await res.json();
                showResponse('userOutput', 'userResponse', data);
                if (res.ok) fetchUsers(); // Auto refresh list
            } catch (err) {
                alert("Error connecting to API");
                console.error(err);
            }
        });

        // 2. Fetch Users
        async function fetchUsers() {
            try {
                const res = await fetch(`${API_URL}/users/`);
                const data = await res.json();
                showResponse('listOutput', 'listResponse', data);
            } catch (err) {
                console.error(err);
            }
        }

        // 3. Create Profile
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('profileUserId').value;
            const profileData = {
                full_name: document.getElementById('fullName').value,
                contact_no: document.getElementById('contact').value,
                address: document.getElementById('address').value,
                blood_group: document.getElementById('blood').value,
                current_status: document.getElementById('status').value,
                profile_pic_drive_id: null
            };

            try {
                const res = await fetch(`${API_URL}/users/${userId}/profile/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
                const data = await res.json();
                showResponse('profileOutput', 'profileResponse', data);
            } catch (err) {
                alert("Error creating profile");
                console.error(err);
            }
        });
    </script>
</body>
</html>